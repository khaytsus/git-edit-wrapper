!/bin/sh

# Editor wrapper script that edits the real file if the file is a symlink (some editors
# clobber symlinks), runs restorecon if selinux is enabled (some editors clobber contexts)
# and adds the edited file to a local git repo

# Warning:  If autogit=1 and no git repo is available in the current or parent
# structure we create a new one in the same path as the file.  If you want a
# more global repo, do git init on a higher path and files will be added to
# that repo instead.  Example:  cd $HOME ; git init

editor=/usr/local/bin/me-bin
restorecon=/sbin/restorecon
getenforce=/usr/sbin/getenforce
autogit=1

file=$1
originalfile=$file

if [ "$file" == "" ]; then
 $editor
 exit
fi

if [ -d "$file" ]; then
 echo "$file is a directory, aborting.."
 exit
fi

# Test to see if we have write permissions, then clean up
filetest=`head /dev/urandom | md5sum | cut -f 1 -d " "`
filetest=${file}-${filetest}
touch $filetest >/dev/null 2>&1
rc=$?
if [ $rc != 0 ]; then
        echo "Could not create $file (no permissions?)  Using more instead"
	more $file
	exit
fi
rm $filetest

md5=`md5sum $originalfile`

if [ -h "$file" ]; then
 file=`readlink -f $file`
 if [ -d "$file" ]; then
  echo "$file is a directory, aborting.."
  exit
 else
  $editor "$file"
 fi
else
 $editor "$file"
fi

# If we didn't create a file, just exit
if [ ! -f "$file" ]; then
 exit
fi

# If using selinux, restore our contexts
if $getenforce | grep -q 'Enforcing\|Permissive'
then
 $restorecon "$file"
fi

# Exit if we didn't change the file at all
new_md5=`md5sum $originalfile`
if [ "$md5" == "$new_md5" ]; then
  exit
fi

# If the file is in a git repo, check in the change
# If autogit is set to 1, we automatically create the repo
dir=`dirname $file`
filename=`basename $file`
pwd=`pwd`
pwd=`readlink -f $pwd`

cd $dir

# Ask user for commit note, otherwise default to something
function readcommit
{
  gitdir=`git rev-parse --git-dir`
  git add $filename
  echo -n "[$gitdir] message: "
  read commit
  if [ "$commit" = "" ]; then
    commit="Automatic edit script commit"
  fi
  git commit -q -m "$commit"
}

# Is there a git repo here?
git rev-parse --git-dir >/dev/null 2>&1
headrc=$?

if [ $headrc == 0 ]; then
  readcommit
else
  if [ "$autogit" = "1" ]; then
    echo "Creating new git repo in" `readlink -f $pwd`
    git init -q
    readcommit
  else
# If autogit=0, offer easy way to add file to a new repo
    echo "cd $dir && git init && git add $filename && git commit -m \"Adding $filename\" && cd $pwd"
  fi
fi
